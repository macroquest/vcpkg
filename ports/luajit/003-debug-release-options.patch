diff --git a/src/msvcbuild.bat b/src/msvcbuild.bat
index 744843a..d1abf76 100644
--- a/src/msvcbuild.bat
+++ b/src/msvcbuild.bat
@@ -15,7 +15,7 @@
 
 @setlocal
 @set SOURCEDIR=%1
-@set LJCOMPILE=cl /nologo /c /O2 /W3 /D_CRT_SECURE_NO_DEPRECATE /D_CRT_STDIO_INLINE=__declspec(dllexport)__inline /I%SOURCEDIR%
+@set LJCOMPILE=cl /nologo /c /W3 /Zi /D_CRT_SECURE_NO_DEPRECATE /I%SOURCEDIR%
 @set LJLINK=link /nologo
 @set LJMT=mt /nologo
 @set LJLIB=lib /nologo /nodefaultlib
@@ -67,10 +67,13 @@ buildvm -m folddef -o %SOURCEDIR%\lj_folddef.h %SOURCEDIR%\lj_opt_fold.c
 @if "%2"=="static" set CRT_LINKAGE=/MT
 @if "%2"=="dynamic" set CRT_LINKAGE=/MD
 @set LJLINK=%LJLINK% /debug
-@if "%3" neq "debug" goto :NODEBUG
+@if "%3" neq "debug" goto :RELEASE
 @shift
-@set LJCOMPILE=%LJCOMPILE% /Zi
+@set LJCOMPILE=%LJCOMPILE% /Od /DLUA_USE_ASSERT /DLUAJIT_ASSERT
 @set CRT_LINKAGE=%CRT_LINKAGE%d
+@goto :NODEBUG
+:RELEASE
+@set LJCOMPILE=%LJCOMPILE% /O2 
 :NODEBUG
 @if "%3"=="amalg" goto :AMALGDLL
 @if "%3"=="static" goto :STATIC
